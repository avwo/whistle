# pattern

åŒ¹é…è¯·æ±‚ URL çš„è¡¨è¾¾å¼ï¼Œæ”¯æŒåŸŸåã€è·¯å¾„ã€é€šé…ç¬¦ã€æ­£åˆ™ç­‰åŒ¹é…æ–¹å¼


## è¯·æ±‚ URL

è¯·æ±‚ URL æœ‰ä¸‰ç§ç±»å‹ï¼š

1. **éš§é“ä»£ç†ï¼š** `tunnel://domain:port`
    > ç¤ºä¾‹ï¼š`tunnel://www.test.com:443`
2. **WebSocketï¼š** `ws[s]://domain[:port]/[path/to[?query]]`
    > ç¤ºä¾‹ï¼š`wss://www.test.com/path?a=1&b=2`
3. **æ™®é€š HTTP/HTTPSï¼š** `http[s]://domain[:port]/[path/to[?query]]`
    > ç¤ºä¾‹ï¼š`https://www.test.com/path?a=1&b=2`

## åŸŸååŒ¹é…
1. æ­£å¸¸åŸŸåï¼š
   - `www.example.com`ã€
   - `1.2.3.4`
   - `//www.example.com`ã€
   - `//1.2.3.4`
      > IP ä¹Ÿå¯ä½œä¸ºåŸŸå
2. å¸¦ç«¯å£åŸŸåï¼š
   - `www.example.com:8080`ã€
   - `//www.example.com:8080`ã€
3. å¸¦åè®®åŸŸåï¼š
   - `tunnel://www.example.com[:port]`
   - `ws[s]://www.example.com[:port]`
   - `http[s]://www.example.com[:port]`

## è·¯å¾„åŒ¹é…
1. æ— åè®®è·¯å¾„ï¼š
   - `www.example.com[:port]/[path/to[?query]]`
   - `//www.example.com[:port]/[path/to[?query]]`
2. å¸¦åè®®è·¯å¾„ï¼š
   - `ws[s]://www.example.com[:port]/[path/to[?query]]`
   - `http[s]://www.example.com[:port]/[path/to[?query]]`
      > TUNNEL è¯·æ±‚æ²¡æœ‰è·¯å¾„

## é€šé…ç¬¦åŒ¹é…

### åŸŸåé€šé…ç¬¦è§„åˆ™

1. **åŸºç¡€é€šé…ç¬¦**ï¼š`*.example.com[:port][/path][?query]`
    > `*` åŒ¹é…ä»»æ„éåˆ†éš”ç¬¦å­—ç¬¦ï¼ˆæ­£åˆ™ï¼š`/[^./?]*/`ï¼‰
    > 
    > ç¤ºä¾‹ï¼š`api.example.com`ã€`shop.example.com:8080`
2. **å¤šçº§é€šé…ç¬¦**ï¼š`**.example.com[:port][/path][?query]`
    > `**` åŒ¹é…ä»»æ„å¤šçº§å­åŸŸï¼ˆæ­£åˆ™ï¼š`/[^/?]*/`ï¼‰
    > 
    > ç¤ºä¾‹ï¼š`a.b.example.com`ã€`x.y.z.example.com/path`
3. **æ··åˆé€šé…ç¬¦**ï¼š`test.abc**.com[:port][/path][?query]`
    > `**` å›ºå®šå‰ç¼€ + å¤šçº§é€šé…ï¼ˆæ­£åˆ™ï¼š`/[^/?]*/`ï¼‰
    > 
    > ç¤ºä¾‹ï¼š`test.abc123.com`ã€`test.abc123.x.com`ã€`test.abc.a.b.com`
4. **åè®®é€šé…ç¬¦**ï¼š`http*://test.abc**.com[:port][/path][?query]`
    > åè®®ä¸­çš„ `*` åŒ¹é…ä»»æ„å­—æ¯æˆ–å†’å·ï¼ˆæ­£åˆ™ï¼š`/[a-z:]*/`ï¼‰
    > 
    > ç¤ºä¾‹ï¼š`https://...`ã€`http://...`
5. **ç‰¹æ®Šè§„åˆ™**ï¼š`***.example.com[:port][/path][?query]`
   > ç›¸å½“äºåŒæ—¶åŒ¹é…ï¼šæ ¹åŸŸåï¼ˆexample.comï¼‰+ å¤šçº§å­åŸŸï¼ˆ**.example.comï¼‰
   > 
   > ç¤ºä¾‹ï¼šexample.comã€a.example.comã€a.b.example.com/path?q=1

é™¤ä¸Šè¿°ç‰¹æ®Šè§„åˆ™ï¼ˆ`***.`ï¼‰å¤–ï¼Œåè®®æˆ–åŸŸåéƒ¨åˆ†å‡ºç°3ä¸ªåŠä»¥ä¸Šè¿ç»­çš„æ˜Ÿå·ï¼ˆå¦‚æˆ– `***`ã€`****`ï¼‰æ—¶ï¼Œå…¶åŠŸèƒ½ç­‰åŒäº2ä¸ªæ˜Ÿå·ï¼ˆ`**`ï¼‰

### è·¯å¾„é€šé…ç¬¦
ç”±äº `*` æ˜¯åˆæ³•çš„ URL è·¯å¾„å­—ç¬¦ï¼Œå½“éœ€è¦å°†å…¶ä½œä¸ºé€šé…ç¬¦ä½¿ç”¨æ—¶ï¼Œåœ¨è¡¨è¾¾å¼å‰é¢åŠ  `^` æ˜¾å¼å£°æ˜ï¼š

``` txt
^[[schema:]//]domain[:port]/pa**th?qu*ery
```
> ç¤ºä¾‹ï¼š`^http*://**.example.com/data/*/result?q=*23`

åè®®å’ŒåŸŸåçš„é€šé…ç¬¦åŠŸèƒ½åŒä¸Šé¢çš„åŸŸåé€šé…ç¬¦è§„åˆ™ï¼Œçº¯è·¯å¾„åŠè¯·æ±‚å‚æ•°çš„é€šé…ç¬¦è§„åˆ™å¦‚ä¸‹ï¼š

##### è·¯å¾„éƒ¨åˆ†çš„é€šé…ç¬¦

| é€šé…ç¬¦ | æ­£åˆ™ç­‰ä»·   | åŒ¹é…èŒƒå›´                    | ç¤ºä¾‹åŒ¹é…                                 |
| ------ | ---------- | --------------------------- | ----------------------------------- |
| `*`    | `/[^?/]*/` | å•çº§è·¯å¾„ï¼ˆä¸å« `/` å’Œ `?`ï¼‰ | `^.../*/*.js` -> `.../a/b.js`          |
| `**`   | `/[^?]*/`  | å¤šçº§è·¯å¾„ï¼ˆä¸å« `?`ï¼‰        | `^.../**file` -> `.../a/b/c/test-file` |
| `***`  | `/.*/`     | ä»»æ„å­—ç¬¦ï¼ˆå« `/` å’Œ `?`ï¼‰   | `^.../data/***file` -> `.../a/b/c?test=file` |



##### è¯·æ±‚å‚æ•°éƒ¨åˆ†çš„é€šé…ç¬¦

| é€šé…ç¬¦ | æ­£åˆ™ç­‰ä»·  | åŒ¹é…èŒƒå›´             | ç¤ºä¾‹åŒ¹é…            |
| ------ | --------- | -------------------- | ------------------- |
| `*`    | `/[^&]*/` | å•å‚æ•°å€¼ï¼ˆä¸å« `&`ï¼‰ | `^...?q=*123` -> `...?q=abc123`  |
| `**`   | `/.*/`    | ä»»æ„å­—ç¬¦ï¼ˆå« `&`ï¼‰   | `^...?q=**123` -> `...?q=abc&test=123` |

## æ­£åˆ™åŒ¹é…
é™¤ç®€å•åŒ¹é…è§„åˆ™å¤–ï¼ŒWhistle æä¾›å®Œæ•´çš„æ­£åˆ™è¡¨è¾¾å¼æ”¯æŒï¼Œè¯­æ³•ä¸ JavaScript æ­£åˆ™å®Œå…¨å…¼å®¹ï¼š
``` txt
/pattern/[flags]
```

- patternï¼šæ­£åˆ™è¡¨è¾¾å¼ä¸»ä½“
- flagsï¼šåŒ¹é…æ¨¡å¼ä¿®é¥°ç¬¦ï¼ˆå¯é€‰ï¼‰æ”¯æŒï¼š
    - `i`	å¿½ç•¥å¤§å°å†™ `/abc/i` åŒ¹é… "AbC"
    - `u`	å¯ç”¨ Unicode æ”¯æŒ	`/\p{Emoji}/u` åŒ¹é… "ğŸ˜€"

ç¤ºä¾‹ï¼š
``` txt
/\.test\./          # åŒ¹é… ".test."
/key=value/i        # å¿½ç•¥å¤§å°å†™åŒ¹é… "key=value"
/\/statics\//ui     # Unicode æ¨¡å¼åŒ¹é… "/statics/"
```

## å­åŒ¹é…ä¼ å€¼

åœ¨ Whistle çš„è§„åˆ™é…ç½®ä¸­ï¼Œå¯ä»¥é€šè¿‡ $0ã€$1 è‡³ $9 å¼•ç”¨é€šé…ç¬¦æˆ–æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„å­åŒ¹é…å†…å®¹ï¼Œå¹¶å°†å…¶ä¼ é€’åˆ°æ“ä½œå€¼ä¸­ï¼š

``` txt
pattern protocol://$0_$1_$2_..._$1
```

- **$0**ï¼šå®Œæ•´åŒ¹é…ç»“æœ
- **$1 - $9**ï¼šå¯¹åº”æ•è·ç»„çš„å†…å®¹

#### é€šé…ç¬¦åŒ¹é…ä¼ å€¼
``` txt
^http://*.example.com/v0/users/** file:///User/xxx/$1/$2
```

- **åŒ¹é…**ï¼š`http://www.example.com/v2/users/alice/test.html?q=1`
- **ä¼ å€¼**ï¼š
  - `$1` = `www`
  - `$2` = `users/alice`
- ç»“æœï¼šæ›¿æ¢æœ¬åœ°æ–‡ä»¶ `/User/xxx/www/alice/test.html` çš„å†…å®¹

#### æ­£åˆ™åŒ¹é…ä¼ å€¼
``` txt
/regexp\/(user|admin)\/(\d+)/ reqHeaders://X-Type=$1&X-ID=$2
```

- **åŒ¹é…**ï¼š`.../regexp/admin/123`
- **ä¼ å€¼**ï¼š
  - `$1` = `admin`
  - `$2` = `123`
- **ç»“æœ**ï¼šæ·»åŠ è¯·æ±‚å¤´ `X-Type: admin` å’Œ `X-ID: 123`


